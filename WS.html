<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Worksheet - Half A4 Vertical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    @media print {
      .no-print { display: none !important; }
      body { background: white; margin: 0; }
      .sheet { box-shadow: none !important; border: 1px solid #000 !important; margin: 0 !important; }
    }
    .sheet {
      width: 14.85cm;
      height: 21cm; /* Half A4 Vertical */
      padding: 0.6cm 0.8cm;
      margin: 10px auto;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border: 1px solid #ccc;
      position: relative;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    th, td { border: 1px solid #000; padding: 4px 6px; vertical-align: middle; }
    th { background: #f2f2f2; font-weight: 800; }
    .val-prep { font-weight: 800; font-size: 14px; text-align: right; }
    .val-cumul { font-weight: 800; font-size: 14px; text-align: right; background: #ffffed; color: #d97706; }
    .bag-badge { position: absolute; top: 1cm; right: 0.8cm; border: 4px solid red; color: red; padding: 5px 15px; font-size: 24px; font-weight: 900; transform: rotate(5deg); }
    [contenteditable="true"]:hover { background: #fff9c4; outline: 1px dashed #999; }
  </style>
</head>
<body class="bg-gray-100 pb-10">

  <div class="no-print max-w-2xl mx-auto my-5 p-4 bg-white rounded-2xl shadow-sm border flex items-center justify-between">
    <div class="flex items-center gap-4">
        <span class="font-black">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</span>
        <select id="bagCount" onchange="renderAll()" class="p-2 border-2 border-blue-500 rounded-xl font-black">
            <option value="1">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 1 ‡∏ñ‡∏∏‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="2">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 2 ‡∏ñ‡∏∏‡∏á (x2)</option>
        </select>
    </div>
    <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-black hover:bg-blue-700">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
  </div>

  <div id="ws-container"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const row = urlParams.get('row');
      if (row) {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${row}`);
        rawData = await res.json();
        renderAll();
      }
    });

    const smartFix = (v, div = 1) => {
      let num = (parseFloat(v) || 0) / div;
      return Number(Math.round(num * 100) / 100).toFixed(2);
    };

    function renderAll() {
      if (!rawData) return;
      const div = parseInt(document.getElementById('bagCount').value);
      document.getElementById('ws-container').innerHTML = createSheet(rawData, div);
    }

    function createSheet(o, div) {
      const d = new Date(o.order_date);
      const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
      
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á)
      const vW_P = parseFloat(o.water_prep || 0) / div;
      const vD_P = parseFloat(o.dex_prep || 0) / div;
      const vProt = parseFloat(o.protein_vol || 0) / div;
      const vPhos = parseFloat(o.phos_vol || 0) / div;
      const vNa = parseFloat(o.na_vol || 0) / div;
      const vK = parseFloat(o.k_vol || 0) / div;
      const vMg = parseFloat(o.mg_vol || 0) / div;
      const vCa = parseFloat(o.ca_vol || 0) / div;
      const vPed = parseFloat(o.peditrace_vol || 0) / div;
      const vZinc = parseFloat(o.zinc_vol || 0) / div;
      const vSolu = parseFloat(o.soluvit_vol || 0) / div;
      const vOther = parseFloat(o.additive_other_volume || 0) / div;
      const vHep = parseFloat(o.heparin_vol || 0) / div;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Cumulative Sum (‡∏ö‡∏ß‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô)
      const c1 = vW_P;
      const c2 = c1 + vD_P;
      const c3 = c2 + vProt;
      const c4 = c3 + vPhos;
      const c5 = c4 + vNa;
      const c6 = c5 + vK;
      const c7 = c6 + vMg;
      const c8 = c7 + vCa;
      const c9 = c8 + vPed;
      const c10 = c9 + vZinc;
      const c11 = c10 + vSolu;
      const c12 = c11 + vOther;
      const c13 = c12 + vHep;

      return `
        <div class="sheet" contenteditable="true">
          ${div === 2 ? '<div class="bag-badge">PREP x 2 BAGS</div>' : ''}
          
          <div class="border-b-4 border-black pb-2">
            <h1 class="text-2xl font-black">TPN WORKSHEET</h1>
            <div class="flex justify-between mt-1">
              <div class="text-sm">
                <p><strong>Name:</strong> ${o.patient_name}</p>
                <p><strong>HN:</strong> ${o.hn} | <strong>BW:</strong> ${o.bw} kg</p>
                <p><strong>Date:</strong> ${dateStr}</p>
              </div>
              <div class="text-right">
                <p class="text-[10px] uppercase font-bold text-gray-400">Ward</p>
                <p class="text-5xl font-black leading-none">${o.ward || '-'}</p>
              </div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 8%;">No.</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                <th style="width: 20%;">Prep Vol</th>
                <th style="width: 22%;">‡∏ñ‡∏∏‡∏á‡∏£‡∏ß‡∏° (ml)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td class="text-center">1</td><td>Sterile Water <span class="text-[9px] font-normal">(${smartFix(o.water_net, div)})</span></td><td class="val-prep">${smartFix(o.water_prep, div)}</td><td class="val-cumul">${c1.toFixed(2)}</td></tr>
              <tr><td class="text-center">2</td><td>50% Dextrose <span class="text-[9px] font-normal">(${smartFix(o.dex_vol, div)})</span></td><td class="val-prep">${smartFix(o.dex_prep, div)}</td><td class="val-cumul">${c2.toFixed(2)}</td></tr>
              <tr><td class="text-center">3</td><td>Amino Acid (Protein)</td><td class="val-prep">${smartFix(o.protein_vol, div)}</td><td class="val-cumul">${c3.toFixed(2)}</td></tr>
              <tr><td class="text-center">4</td><td>Glycophos (P)</td><td class="val-prep">${smartFix(o.phos_vol, div)}</td><td class="val-cumul">${c4.toFixed(2)}</td></tr>
              <tr><td class="text-center">5</td><td>3% NaCl (Na)</td><td class="val-prep">${smartFix(o.na_vol, div)}</td><td class="val-cumul">${c5.toFixed(2)}</td></tr>
              <tr><td class="text-center">6</td><td>15% KCl (K)</td><td class="val-prep">${smartFix(o.k_vol, div)}</td><td class="val-cumul">${c6.toFixed(2)}</td></tr>
              <tr><td class="text-center">7</td><td>50% MgSO4 (Mg)</td><td class="val-prep">${smartFix(o.mg_vol, div)}</td><td class="val-cumul">${c7.toFixed(2)}</td></tr>
              <tr><td class="text-center">8</td><td>10% Ca Gluconate</td><td class="val-prep">${smartFix(o.ca_vol, div)}</td><td class="val-cumul">${c8.toFixed(2)}</td></tr>
              <tr><td class="text-center">9</td><td>Peditrace / Tracutil</td><td class="val-prep">${smartFix(o.peditrace_vol, div)}</td><td class="val-cumul">${c9.toFixed(2)}</td></tr>
              <tr><td class="text-center">10</td><td>Zinc Sulfate</td><td class="val-prep">${smartFix(o.zinc_vol, div)}</td><td class="val-cumul">${c10.toFixed(2)}</td></tr>
              <tr><td class="text-center">11</td><td>Soluvit-N</td><td class="val-prep">${smartFix(o.soluvit_vol, div)}</td><td class="val-cumul">${c11.toFixed(2)}</td></tr>
              <tr><td class="text-center">12</td><td>Additive ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</td><td class="val-prep">${smartFix(o.additive_other_volume, div)}</td><td class="val-cumul">${c12.toFixed(2)}</td></tr>
              <tr><td class="text-center">13</td><td>Heparin (1:1000)</td><td class="val-prep">${smartFix(o.heparin_vol, div)}</td><td class="val-cumul">${c13.toFixed(2)}</td></tr>
              
              <tr class="bg-gray-100">
                <td colspan="2" class="text-right font-black">Total PN in Bag (ml)</td>
                <td colspan="2" class="text-center text-xl font-black text-blue-800">${smartFix(o.pn_volume, div)}</td>
              </tr>
            </tbody>
          </table>

          <div class="mt-4 border-t border-black pt-2">
            <h3 class="font-bold underline text-sm">Fat Section:</h3>
            <div class="grid grid-cols-2 text-xs mt-1">
              <div>
                <p>Product: ${o.fat_product_name || 'N/A'}</p>
                <p>Volume: ${smartFix(o.total_fat_vit_flush, div)} ml</p>
              </div>
              <div class="text-right">
                <p>Rate: ${o.fat_rate} ml/hr</p>
                <p>Flush: ${smartFix(o.flush_volume, div)} ml</p>
              </div>
            </div>
          </div>

          <div class="absolute bottom-6 left-8 right-8 flex justify-between text-center">
            <div><div class="w-28 border-b border-black"></div><p class="text-[10px] mt-1">‡∏Ñ‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</p></div>
            <div><div class="w-28 border-b border-black"></div><p class="text-[10px] mt-1">‡∏Ñ‡∏ô‡∏ï‡∏£‡∏ß‡∏à</p></div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
