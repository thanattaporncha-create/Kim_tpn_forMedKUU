<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Worksheet - Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    @media print {
      .no-print { display: none !important; }
      body { background: white; margin: 0; }
      .sheet { box-shadow: none !important; border: 1px solid #000 !important; margin: 0 !important; }
    }
    .sheet {
      width: 14.85cm; height: 21cm; padding: 0.5cm 0.7cm;
      margin: 10px auto; background: white; border: 1px solid #000; position: relative;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12.5px; }
    th, td { border: 1px solid #000; padding: 3px 5px; vertical-align: middle; }
    th { font-weight: 800; }
    .val-prep { font-weight: 800; text-align: right; }
    .val-cumul { font-weight: 800; text-align: right; }
    .bag-badge { position: absolute; top: 0.4cm; left: 0.7cm; border: 2px solid #000; padding: 2px 8px; font-size: 18px; font-weight: 900; }
    [contenteditable="true"]:hover { outline: 1px dashed #000; }
  </style>
</head>
<body>

  <div class="no-print p-4 bg-gray-100 flex justify-between items-center max-w-2xl mx-auto">
    <div class="flex items-center gap-4">
        <span class="font-bold">โหมด:</span>
        <select id="bagCount" onchange="renderAll()" class="p-2 border border-black font-bold">
            <option value="1">เตรียม 1 ถุงปกติ</option>
            <option value="2">แบ่งเตรียม 2 ถุง (x2)</option>
        </select>
    </div>
    <button onclick="window.print()" class="bg-black text-white px-6 py-2 font-bold">พิมพ์ WORKSHEET</button>
  </div>

  <div id="ws-container"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const row = urlParams.get('row');
      if (row) {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${row}`);
        rawData = await res.json();
        renderAll();
      }
    });

    const smartFix = (v, div = 1) => {
      let num = (parseFloat(v) || 0) / div;
      return Number(Math.round(num * 100) / 100).toFixed(2);
    };

    function renderAll() {
      if (!rawData) return;
      const div = parseInt(document.getElementById('bagCount').value);
      document.getElementById('ws-container').innerHTML = createSheet(rawData, div);
    }

    function createSheet(o, div) {
      const getVal = (v) => parseFloat(v || 0) / div;
      
      // ดึงค่าตามชื่อคอลัมน์ที่คุณขิมแจ้ง
      const vW_P = getVal(o.Prep_Water_Vol); 
      const vD_P = getVal(o.Prep_Dex_50_Vol);
      const vProt = getVal(o.protein_vol);
      const vPhos = getVal(o.phos_vol);
      const vNa = getVal(o.na_vol);
      const vK = getVal(o.k_vol);
      const vMg = getVal(o.mg_vol);
      const vCa = getVal(o.ca_vol);
      const vPed = getVal(o.peditrace_vol);
      const vZinc = getVal(o.zinc_vol);
      const vSolu = getVal(o.soluvit_vol);
      const vOther = getVal(o.additive_other_volume);
      const vHep = getVal(o.heparin_vol);

      let currentSum = 0;
      const calcCumul = (val) => { 
        currentSum += val; 
        return currentSum.toFixed(2); 
      };

      return `
        <div class="sheet" contenteditable="true">
          ${div === 2 ? '<div class="bag-badge">PREP x 2 BAGS</div>' : ''}
          
          <div class="border-b-2 border-black pb-1 mb-2 flex justify-between items-start">
            <div>
              <h1 class="text-xl font-black">TPN WORKSHEET</h1>
              <p class="text-sm font-bold">${o.patient_name} (HN: ${o.hn})</p>
              <p class="text-[11px]">BW: ${o.bw} kg | Date: ${new Date(o.order_date).toLocaleDateString('th-TH')}</p>
            </div>
            <div class="text-right">
              <p class="text-[10px] font-bold">WARD</p>
              <p class="text-5xl font-black leading-none">${o.ward || '-'}</p>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 5%;">#</th>
                <th style="text-align: left;">รายการสารอาหาร</th>
                <th style="width: 22%;">Prep Vol (ml)</th>
                <th style="width: 22%;">ถุงรวม (ml)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td class="text-center">1</td><td>Sterile Water <small>(${smartFix(o.water_net, div)})</small></td><td class="val-prep">${vW_P.toFixed(2)}</td><td class="val-cumul">${calcCumul(vW_P)}</td></tr>
              <tr><td class="text-center">2</td><td>50% Dextrose <small>(${smartFix(o.dex_vol, div)})</small></td><td class="val-prep">${vD_P.toFixed(2)}</td><td class="val-cumul">${calcCumul(vD_P)}</td></tr>
              <tr><td class="text-center">3</td><td>Amino Acid (Protein)</td><td class="val-prep">${vProt.toFixed(2)}</td><td class="val-cumul">${calcCumul(vProt)}</td></tr>
              <tr><td class="text-center">4</td><td>Glycophos (P)</td><td class="val-prep">${vPhos.toFixed(2)}</td><td class="val-cumul">${calcCumul(vPhos)}</td></tr>
              <tr><td class="text-center">5</td><td>3% NaCl (Na)</td><td class="val-prep">${vNa.toFixed(2)}</td><td class="val-cumul">${calcCumul(vNa)}</td></tr>
              <tr><td class="text-center">6</td><td>15% KCl (K)</td><td class="val-prep">${vK.toFixed(2)}</td><td class="val-cumul">${calcCumul(vK)}</td></tr>
              <tr><td class="text-center">7</td><td>50% MgSO4 (Mg)</td><td class="val-prep">${vMg.toFixed(2)}</td><td class="val-cumul">${calcCumul(vMg)}</td></tr>
              <tr><td class="text-center">8</td><td>10% Ca Gluconate</td><td class="val-prep">${vCa.toFixed(2)}</td><td class="val-cumul">${calcCumul(vCa)}</td></tr>
              <tr><td class="text-center">9</td><td>Peditrace / Tracutil</td><td class="val-prep">${vPed.toFixed(2)}</td><td class="val-cumul">${calcCumul(vPed)}</td></tr>
              <tr><td class="text-center">10</td><td>Zinc Sulfate</td><td class="val-prep">${vZinc.toFixed(2)}</td><td class="val-cumul">${calcCumul(vZinc)}</td></tr>
              <tr><td class="text-center">11</td><td>Soluvit-N</td><td class="val-prep">${vSolu.toFixed(2)}</td><td class="val-cumul">${calcCumul(vSolu)}</td></tr>
              <tr><td class="text-center">12</td><td>Additive อื่นๆ</td><td class="val-prep">${vOther.toFixed(2)}</td><td class="val-cumul">${calcCumul(vOther)}</td></tr>
              <tr><td class="text-center">13</td><td>Heparin (1:1000)</td><td class="val-prep">${vHep.toFixed(2)}</td><td class="val-cumul">${calcCumul(vHep)}</td></tr>
              <tr class="font-black text-sm">
                <td colspan="2" class="text-right">Total PN Prep in Bag:</td>
                <td colspan="2" class="text-center border-l-2 border-black text-lg">${smartFix(o.PN_Prep_Total, div)} ml</td>
              </tr>
            </tbody>
          </table>

          <div class="mt-4 border-t border-black pt-2 flex justify-between">
            <div class="text-[10px]">
                <strong>Fat:</strong> ${o.fat_product_name || '-'} | Vol: ${smartFix(o.total_fat_vit_flush, div)} ml<br>
                Rate: ${o.fat_rate} ml/hr | Prep BW: ${o.bw} kg
            </div>
            <div class="flex gap-4 text-center">
                <div><div class="w-24 border-b border-black"></div><p class="text-[9px]">คนเตรียม</p></div>
                <div><div class="w-24 border-b border-black"></div><p class="text-[9px]">คนตรวจ</p></div>
            </div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
