<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Worksheet - Half A4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.2; }
    @media print {
      .no-print { display: none !important; }
      body { background: white; margin: 0; }
      .sheet { box-shadow: none !important; border: 1px solid #000 !important; margin: 0 !important; page-break-after: always; }
    }
    .sheet {
      width: 21cm;
      height: 14.85cm; /* Half A4 Landscape */
      padding: 0.8cm 1cm;
      margin: 10px auto;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 5px; flex-grow: 1; }
    th, td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
    th { background: #f2f2f2; font-weight: 800; font-size: 14px; }
    .val-prep { font-weight: 800; font-size: 16px; text-align: right; }
    .val-cumul { font-weight: 400; font-size: 12px; color: #444; text-align: right; background: #fafafa; width: 60px; }
    [contenteditable="true"]:hover { background: #fff9c4; outline: 1px dashed #999; }
  </style>
</head>
<body class="bg-gray-100 pb-10">

  <div class="no-print max-w-4xl mx-auto my-5 p-4 bg-white rounded-2xl shadow-sm border flex items-center justify-between">
    <div class="flex items-center gap-4">
        <span class="font-black">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á:</span>
        <select id="bagCount" onchange="renderAll()" class="p-2 border-2 border-blue-500 rounded-xl font-black">
            <option value="1">1 ‡∏ñ‡∏∏‡∏á (Full Dose)</option>
            <option value="2">2 ‡∏ñ‡∏∏‡∏á (‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á)</option>
        </select>
    </div>
    <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-black hover:bg-blue-700 transition-all">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå Worksheet</button>
  </div>

  <div id="ws-container"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const row = urlParams.get('row');
      if (row) {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${row}`);
        rawData = await res.json();
        renderAll();
      }
    });

    const smartFix = (v, div = 1) => {
      let num = (parseFloat(v) || 0) / div;
      return Number(Math.round(num * 100) / 100).toFixed(2);
    };

    function renderAll() {
      if (!rawData) return;
      const div = parseInt(document.getElementById('bagCount').value);
      const container = document.getElementById('ws-container');
      container.innerHTML = '';
      for (let i = 1; i <= div; i++) {
        container.innerHTML += createSheet(rawData, i, div);
      }
    }

    function createSheet(o, bNum, div) {
      const d = new Date(o.order_date);
      const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
      
      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (‡∏´‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á)
      const vWater = parseFloat(o.water_prep) / div;
      const vDex = parseFloat(o.dex_prep) / div;
      const vProt = parseFloat(o.protein_vol) / div;
      const vPhos = parseFloat(o.phos_vol) / div;
      const vNa = parseFloat(o.na_vol) / div;
      const vK = parseFloat(o.k_vol) / div;
      const vMg = parseFloat(o.mg_vol) / div;
      const vCa = parseFloat(o.ca_vol) / div;
      const vPed = parseFloat(o.peditrace_vol) / div;
      const vZinc = parseFloat(o.zinc_vol) / div;
      const vSolu = parseFloat(o.soluvit_vol) / div;
      const vHep = parseFloat(o.heparin_vol) / div;
      const vOther = parseFloat(o.additive_other_volume) / div;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏™‡∏∞‡∏™‡∏° (Cumulative) ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°
      const cum1 = vWater + vDex; // Water + Dex
      const cum2 = cum1 + vProt;  // + Amino
      const cum3 = cum2 + vPhos + vNa; // + Phos + Na

      return `
        <div class="sheet" contenteditable="true">
          <div class="flex justify-between items-end border-b-2 border-black pb-2">
            <div class="flex-1">
              <div class="text-[10px] font-bold uppercase text-gray-500">TPN Preparation Worksheet (Bag ${bNum}/${div})</div>
              <div class="text-lg font-black">${o.patient_name} <span class="text-sm font-normal">HN: ${o.hn}</span></div>
              <div class="text-xs font-bold text-blue-800">Date: ${dateStr} | BW: ${o.bw} kg | Route: ${o.route}</div>
            </div>
            <div class="text-right">
              <div class="text-4xl font-black leading-none">${o.ward || '-'}</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 5%;">#</th>
                <th style="text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                <th style="width: 20%;">Order (ml)</th>
                <th style="width: 20%;">Prep Vol (ml)</th>
                <th style="width: 15%;">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-center">1</td>
                <td>Sterile Water <span class="text-[10px] font-normal">(${smartFix(o.water_net, div)})</span></td>
                <td class="text-center text-gray-400">-</td>
                <td class="val-prep">${smartFix(o.water_prep, div)}</td>
                <td class="val-cumul"></td>
              </tr>
              <tr>
                <td class="text-center">2</td>
                <td>50% Dextrose <span class="text-[10px] font-normal">(${smartFix(o.dex_vol, div)})</span></td>
                <td class="text-center text-gray-400">-</td>
                <td class="val-prep">${smartFix(o.dex_prep, div)}</td>
                <td class="val-cumul">(${cum1.toFixed(2)})</td>
              </tr>
              <tr>
                <td class="text-center">3</td>
                <td>Amino Acid (Protein)</td>
                <td class="text-right">${smartFix(o.protein_vol, div)}</td>
                <td class="val-prep">${smartFix(o.protein_vol, div)}</td>
                <td class="val-cumul">(${cum2.toFixed(2)})</td>
              </tr>
              <tr>
                <td class="text-center">4</td>
                <td>Glycophos (P)</td>
                <td class="text-right">${smartFix(o.phos_vol, div)}</td>
                <td class="val-prep">${smartFix(o.phos_vol, div)}</td>
                <td class="val-cumul"></td>
              </tr>
              <tr>
                <td class="text-center">5</td>
                <td>3% NaCl (Na)</td>
                <td class="text-right">${smartFix(o.na_vol, div)}</td>
                <td class="val-prep">${smartFix(o.na_vol, div)}</td>
                <td class="val-cumul">(${cum3.toFixed(2)})</td>
              </tr>
              <tr><td class="text-center text-[10px]">6-13</td><td colspan="4" class="text-[10px] font-bold bg-gray-50 italic">Additive ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (KCl, Mg, Ca, Trace, Zinc, Soluvit, Heparin, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)</td></tr>
              <tr>
                <td colspan="3" class="text-right font-black text-xs uppercase">Total PN volume in bag:</td>
                <td class="val-prep text-blue-700">${smartFix(o.pn_volume, div)}</td>
                <td class="val-cumul"></td>
              </tr>
            </tbody>
          </table>

          <div class="mt-4 grid grid-cols-2 gap-4">
             <div class="border border-dashed border-black p-2 text-[10px]">
                <strong>Fat Section:</strong> ${o.fat_product_name || 'N/A'} Rate: ${o.fat_rate} ml/hr<br>
                Vol: ${smartFix(o.total_fat_vit_flush, div)} ml (Inc. Vit & Flush)
             </div>
             <div class="flex items-end justify-between px-2">
                <div class="text-center"><div class="w-24 border-b border-black"></div><div class="text-[8px]">‡∏Ñ‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div></div>
                <div class="text-center"><div class="w-24 border-b border-black"></div><div class="text-[8px]">‡∏Ñ‡∏ô‡∏ï‡∏£‡∏ß‡∏à</div></div>
             </div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
