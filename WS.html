<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Worksheet - Pro Version</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.05; }
    @media print {
      .no-print { display: none !important; }
      body { background: white; margin: 0; }
      .sheet { box-shadow: none !important; border: 1px solid #000 !important; margin: 0 !important; }
    }
    .sheet {
      width: 14.85cm; height: 21cm; padding: 0.8cm 1cm;
      margin: 10px auto; background: white; border: 1px solid #000; position: relative;
      display: flex; flex-direction: column;
    }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡πÉ‡∏à */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 16px; flex-grow: 1; }
    th, td { border: 1px solid #000; padding: 6px 10px; vertical-align: middle; }
    th { font-weight: 800; font-size: 15px; }
    .val-prep { font-weight: 800; font-size: 18px; text-align: right; }
    .val-cumul { font-weight: 800; font-size: 18px; text-align: right; }
    .bag-badge { border: 3px solid #000; padding: 4px 15px; font-size: 20px; font-weight: 900; display: inline-block; margin-bottom: 8px; }
    
    /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á 3.5 cm */
    .footer-sign { height: 3.5cm; display: flex; align-items: flex-end; justify-content: space-between; padding: 0 20px 20px 20px; }
    [contenteditable="true"]:hover { outline: 1px dashed #000; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="no-print p-4 bg-gray-200 flex justify-between items-center max-w-2xl mx-auto shadow-md">
    <div class="flex items-center gap-4">
        <span class="font-bold">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</span>
        <select id="bagCount" onchange="renderAll()" class="p-2 border-2 border-black font-black bg-white">
            <option value="1">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 1 ‡∏ñ‡∏∏‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="2">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 2 ‡∏ñ‡∏∏‡∏á (x2)</option>
        </select>
    </div>
    <button onclick="window.print()" class="bg-black text-white px-8 py-3 font-black text-lg hover:invert transition-all">üñ®Ô∏è PRINT</button>
  </div>

  <div id="ws-container"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5|VNNX7lFK/exec'; // ‡∏•‡∏π‡∏°‡∏¥‡∏•‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞
    let rawData = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const row = urlParams.get('row');
      if (row) {
        const res = await fetch(`https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec?action=getDataDetail&row_index=${row}`);
        rawData = await res.json();
        renderAll();
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©: 5.10 -> 5.1, 5.00 -> 5
    const formatNum = (v, div = 1) => {
      let num = (parseFloat(v) || 0) / div;
      let rounded = Math.round(num * 100) / 100;
      return parseFloat(rounded.toFixed(2)).toString(); 
    };

    function renderAll() {
      if (!rawData) return;
      const div = parseInt(document.getElementById('bagCount').value);
      document.getElementById('ws-container').innerHTML = createSheet(rawData, div);
    }

    function createSheet(o, div) {
      const getVal = (v) => (parseFloat(v) || 0) / div;
      
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô
      const getProtName = (n) => {
        const name = n?.toLowerCase() || "";
        if (name.includes("aminoven")) return "10% Aminoven- Infant ‚ú±";
        if (name.includes("amiparen")) return "10% AmiPa-REN";
        if (name.includes("aminoplasmal")) return "15% AminoPlas-MAL";
        return n || "Amino Acid";
      };

      const vW_P = getVal(o.prep_water_vol || o.water_net);
      const vD_P = getVal(o.prep_dex_50_vol || o.dex_vol);
      const vProt = getVal(o.prep_protein_vol || o.protein_vol);
      const vPhos = getVal(o.prep_phos_vol || o.phos_vol);
      const vNa = getVal(o.prep_na_vol || o.na_vol);
      const vK = getVal(o.prep_k_vol || o.k_vol);
      const vMg = getVal(o.prep_mg_vol || o.mg_vol);
      const vCa = getVal(o.prep_ca_vol || o.ca_vol);
      const vPed = getVal(o.peditrace_vol);
      const vZinc = getVal(o.zinc_vol);
      const vSolu = getVal(o.soluvit_vol);
      const vOther = getVal(o.additive_other_volume);
      const vHep = getVal(o.heparin_vol);

      let currentSum = 0;
      const calcCumul = (val, show) => { 
        currentSum += val; 
        return show ? formatNum(currentSum) : ""; 
      };

      const flushVal = 30 / div;

      return `
        <div class="sheet" contenteditable="true">
          ${div === 2 ? '<div class="bag-badge">PREP x 2 BAGS</div>' : ''}
          
          <div class="flex justify-between items-start">
             <div><h1 class="text-3xl font-black italic">TPN WORKSHEET</h1></div>
             <div class="text-right">
                <p class="text-[10px] font-bold">WARD</p>
                <p class="text-6xl font-black leading-none">${o.ward || '-'}</p>
             </div>
          </div>
          
          <div class="border-b-4 border-black pb-2 mb-2 mt-2">
            <p class="text-2xl font-black">${o.patient_name} (HN: ${o.hn})</p>
            <p class="text-lg font-bold">BW: ${o.bw} kg | Date: ${new Date(o.order_date).toLocaleDateString('th-TH')}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 7%;">#</th>
                <th style="text-align: left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                <th style="width: 23%;">Prep Vol (ml)</th>
                <th style="width: 23%;">‡∏ñ‡∏∏‡∏á‡∏£‡∏ß‡∏° (ml)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td class="text-center">1</td><td>Sterile Water <small>(${formatNum(o.water_net, div)})</small></td><td class="val-prep">${formatNum(o.prep_water_vol || o.water_net, div)}</td><td class="val-cumul"></td></tr>
              <tr><td class="text-center">2</td><td>50% D-W <small>(${formatNum(o.dex_vol, div)})</small></td><td class="val-prep">${formatNum(o.prep_dex_50_vol || o.dex_vol, div)}</td><td class="val-cumul">${calcCumul(vW_P + vD_P, true)}</td></tr>
              <tr><td class="text-center">3</td><td>${getProtName(o.protein_product_name)}</td><td class="val-prep">${formatNum(vProt)}</td><td class="val-cumul">${calcCumul(vProt, true)}</td></tr>
              <tr><td class="text-center">4</td><td>Glycophos (P)</td><td class="val-prep">${formatNum(vPhos)}</td><td class="val-cumul">${calcCumul(vPhos, false)}</td></tr>
              <tr><td class="text-center">5</td><td>3% NaCl (Na)</td><td class="val-prep">${formatNum(vNa)}</td><td class="val-cumul">${calcCumul(vNa, true)}</td></tr>
              <tr><td class="text-center">6</td><td>15% KCl (K)</td><td class="val-prep">${formatNum(vK)}</td><td class="val-cumul">${calcCumul(vK, false)}</td></tr>
              <tr><td class="text-center">7</td><td>50% MgSO4 (Mg)</td><td class="val-prep">${formatNum(vMg)}</td><td class="val-cumul">${calcCumul(vMg, false)}</td></tr>
              <tr><td class="text-center">8</td><td>10% Ca Gluconate</td><td class="val-prep">${formatNum(vCa)}</td><td class="val-cumul">${calcCumul(vCa, false)}</td></tr>
              <tr><td class="text-center">9</td><td>Peditrace</td><td class="val-prep">${formatNum(vPed)}</td><td class="val-cumul">${calcCumul(vPed, false)}</td></tr>
              <tr><td class="text-center">10</td><td>Zinc Sulfate</td><td class="val-prep">${formatNum(vZinc)}</td><td class="val-cumul">${calcCumul(vZinc, false)}</td></tr>
              <tr><td class="text-center">11</td><td>Soluvit-N</td><td class="val-prep">${formatNum(vSolu)}</td><td class="val-cumul">${calcCumul(vSolu, false)}</td></tr>
              <tr><td class="text-center">12</td><td>${o.additive_other_name || 'Additive ‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}</td><td class="val-prep">${formatNum(vOther)}</td><td class="val-cumul">${calcCumul(vOther, false)}</td></tr>
              <tr><td class="text-center">13</td><td>Heparin (1u/ml) conc. 500 u/ml</td><td class="val-prep">${formatNum(vHep)}</td><td class="val-cumul">${calcCumul(vHep, false)}</td></tr>
            </tbody>
          </table>

          <div class="mt-4 flex justify-between items-start border-2 border-black p-3 font-bold">
            <div class="text-lg">
                <p>Total PN vol (order): <span class="font-black">${formatNum(o.pn_volume, div)} ml</span></p>
                <p>Total PN vol + ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢ ${flushVal} ml: <span class="font-black">${formatNum(o.pn_prep_total || o.pn_volume, div)} ml</span></p>
            </div>
            <div class="text-right text-sm">
                <p>Fat: ${o.fat_product_name || '-'} | Vol: ${formatNum(o.total_fat_vit_flush, div)} ml</p>
                <p>Osmolarity: ${o.final_osmolarity} mOsmol/L</p>
            </div>
          </div>

          <div class="footer-sign">
            <div class="text-center"><div class="w-32 border-b-2 border-black"></div><p class="font-bold mt-2">‡∏Ñ‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</p></div>
            <div class="text-center"><div class="w-32 border-b-2 border-black"></div><p class="font-bold mt-2">‡∏Ñ‡∏ô‡∏ï‡∏£‡∏ß‡∏à</p></div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
