<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Label System | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    @media print {
      @page { size: 3.5in 2.48in; margin: 0; }
      body { margin: 0; padding: 0; background: #fff; }
      .no-print, .setup-box { display: none !important; }
      .sticker { box-shadow: none !important; border: none !important; margin: 0 !important; }
    }
    .sticker {
      width: 3.5in; height: 2.48in; padding-top: 1.3cm; padding-left: 0.15in; padding-right: 0.15in;
      box-sizing: border-box; page-break-after: always; background: white; position: relative;
    }
    table { width: 100%; font-size: 11px; border-collapse: collapse; }
    td { border: 1px solid #000; padding: 2px 4px; }
    .vol-input { font-weight: 800; border: none; background: transparent; width: 100%; text-align: right; outline: none; }
    .header-info { font-size: 11px; font-weight: 800; border-bottom: 2px solid #000; margin-bottom: 2px; }
    .rate-box { border: 1px solid #000; padding: 2px 5px; font-size: 13px; font-weight: 800; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-md mx-auto my-6 no-print p-4 bg-white rounded-xl shadow-lg border border-gray-200">
    <h2 class="font-black text-lg mb-4 text-center">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</h2>
    <div class="flex gap-4 mb-4">
      <button onclick="changeBottleCount(1)" id="btn1" class="flex-1 py-2 bg-black text-white rounded-lg font-bold">1 ‡∏Ç‡∏ß‡∏î</button>
      <button onclick="changeBottleCount(2)" id="btn2" class="flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold">2 ‡∏Ç‡∏ß‡∏î</button>
    </div>
    <p class="text-[11px] text-gray-500 mb-4">* ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏Ç‡∏ß‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤‡∏£ Volume ‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>
    <button onclick="window.print()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-black shadow-lg hover:bg-blue-700 transition-all">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</button>
  </div>

  <div id="label-container" class="flex flex-col items-center gap-4"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;
    let bottleCount = 1;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const rowIndex = urlParams.get('row');
      if (!rowIndex) return;

      try {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${rowIndex}`);
        rawData = await res.json();
        render();
      } catch (e) { console.error(e); }
    });

    function changeBottleCount(count) {
      bottleCount = count;
      document.getElementById('btn1').className = count === 1 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      document.getElementById('btn2').className = count === 2 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      render();
    }

    function render() {
      if (!rawData) return;
      const container = document.getElementById('label-container');
      container.innerHTML = '';
      
      const div = bottleCount; // ‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£
      
      for (let i = 1; i <= bottleCount; i++) {
        container.innerHTML += createSticker(rawData, i, div, 1); // ‡πÅ‡∏ú‡πà‡∏ô 1
        container.innerHTML += createSticker(rawData, i, div, 2); // ‡πÅ‡∏ú‡πà‡∏ô 2
      }
    }

    function createSticker(o, bNum, div, part) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ß‡∏î
      const getV = (v) => (parseFloat(v) / div).toFixed(div === 2 ? 1 : 1);
      const getV2 = (v) => (parseFloat(v) / div).toFixed(2); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô Heparin

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô
      const getProteinName = (name) => {
          if (name === "aminoven") return "10% Aminoven infant";
          if (name === "amiparen") return "10% Amiparen";
          if (name === "aminoplasmal") return "15% Aminoplasmal";
          return name;
      };

      const expDate = new Date(o.order_date);
      expDate.setDate(expDate.getDate() + 1);
      const expStr = expDate.toLocaleDateString('th-TH') + " @ 18:00 ‡∏ô.";

      if (part === 1) {
        return `
          <div class="sticker">
            <div class="header-info flex justify-between">
              <span>HN: ${o.hn} - ${o.patient_name}</span>
              <span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${bottleCount}</span>
            </div>
            <div class="flex justify-between text-[10px] mb-1 font-bold">
              <span>Ward: ${o.ward || '-'}</span>
              <span>Route: ${o.route || '-'}</span>
            </div>
            <table>
              <tr><td>Sterile Water for Injection</td><td class="text-right"><b><input class="vol-input" value="${getV(o.water_net)}"></b> ml</td></tr>
              <tr><td>50% Dextrose</td><td class="text-right"><b><input class="vol-input" value="${getV(o.dex_vol)}"></b> ml</td></tr>
              <tr><td>${getProteinName(o.protein_product_name)}</td><td class="text-right"><b><input class="vol-input" value="${getV(o.protein_vol)}"></b> ml</td></tr>
              <tr><td>10% Ca Gluconate</td><td class="text-right"><b><input class="vol-input" value="${getV(o.ca_vol)}"></b> ml</td></tr>
              <tr><td>Glycophos (P)</td><td class="text-right"><b><input class="vol-input" value="${getV(o.phos_vol)}"></b> ml</td></tr>
              <tr><td>3% NaCl (Na)</td><td class="text-right"><b><input class="vol-input" value="${getV(o.na_vol)}"></b> ml</td></tr>
              <tr><td>15% KCl (K)</td><td class="text-right"><b><input class="vol-input" value="${getV(o.k_vol)}"></b> ml</td></tr>
              <tr><td>50% MgSO4</td><td class="text-right"><b><input class="vol-input" value="${getV(o.mg_vol)}"></b> ml</td></tr>
            </table>
            <div class="text-right font-bold text-[11px] mt-1 italic">Srinagarind Hospital Pharmacy</div>
          </div>
        `;
      } else {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Clinical Info ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡πà‡∏ô 2
        const gluGrams = ((parseFloat(o.dex_vol) * 0.5) / div).toFixed(1);
        const npc = ((((parseFloat(o.dex_vol) * 0.5) * 3.4) + (parseFloat(o.fat_vol_base) * 2)) / div).toFixed(1);
        const nitrogen = (((parseFloat(o.protein_target) * parseFloat(o.bw)) / 6.25) / div).toFixed(2);
        const npcn = nitrogen > 0 ? Math.round(npc / nitrogen) : 0;

        return `
          <div class="sticker">
            <div class="header-info flex justify-between">
              <span>HN: ${o.hn} - ${o.patient_name}</span>
              <span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${bottleCount}</span>
            </div>
            <table>
               <tr><td>Peditrace</td><td class="text-right"><b><input class="vol-input" value="${getV(o.peditrace_vol)}"></b> ml</td></tr>
               <tr><td>Soluvit-N</td><td class="text-right"><b><input class="vol-input" value="${getV(o.soluvit_vol)}"></b> ml</td></tr>
               <tr><td>${o.additive_other_name || "Other Additive"}</td><td class="text-right"><b><input class="vol-input" value="${getV(o.additive_other_volume)}"></b> ml</td></tr>
               <tr><td>Heparin (1u/ml)</td><td class="text-right"><b><input class="vol-input" value="${getV2(o.heparin_vol)}"></b> ml</td></tr>
            </table>
            <div class="grid grid-cols-2 gap-1 text-[10px] mt-1 border-t border-black pt-1">
              <span>Calories: <b>${(parseFloat(o.total_calories)/div).toFixed(1)} kcal</b></span>
              <span>NPC:N Ratio: <b>${npcn}:1</b></span>
              <span>% Glucose: <b>${o.dextrose_percent} %</b></span>
              <span>GIR: <b>${o.gir_result}</b></span>
              <span>Osmolarity: <b>${o.final_osmolarity} mOsmol/L</b></span>
            </div>
            <div class="flex justify-between items-center mt-2">
              <div class="rate-box font-mono">RATE: ${o.rate_tpn} ml/hr</div>
              <div class="text-[9px] text-right font-bold">
                 EXP: ${expStr}<br>
                 Total Bottle Vol: ${(parseFloat(o.pn_volume)/div).toFixed(1)} ml
              </div>
            </div>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
