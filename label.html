<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Label Preview | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    
    @media print {
      @page {
        size: 3.5in 2.48in; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
        margin: 0;
      }
      body { margin: 0; padding: 0; background: #fff; }
      .no-print { display: none !important; }
      .sticker { box-shadow: none !important; border: none !important; margin: 0 !important; }
    }

    /* Sticker Container */
    .sticker {
      width: 3.5in;
      height: 2.48in;
      padding-top: 1.3cm; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏´‡∏±‡∏ß‡∏â‡∏•‡∏≤‡∏Å 1.3 cm ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ */
      padding-left: 0.15in;
      padding-right: 0.15in;
      padding-bottom: 0.1in;
      box-sizing: border-box;
      page-break-after: always;
      background: white;
      position: relative;
    }

    table { width: 100%; font-size: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #000; padding: 1px 3px; }
    .header-info { font-size: 11px; font-weight: 800; border-bottom: 2px solid #000; margin-bottom: 2px; padding-bottom: 2px; }
    .rate-box { background-color: #f3f4f6; border: 1px solid #000; padding: 2px 5px; font-size: 12px; font-weight: 800; }
    .label-tag { font-size: 9px; font-weight: 800; background: #000; color: #fff; padding: 0 4px; border-radius: 2px; }
  </style>
</head>
<body class="bg-gray-200">

  <div class="max-w-md mx-auto my-6 no-print px-4">
    <div class="bg-white p-4 rounded-2xl shadow-lg border border-blue-100 text-center">
      <h2 class="font-black text-blue-900 mb-2 text-lg">üè∑Ô∏è Preview ‡∏â‡∏•‡∏≤‡∏Å TPN</h2>
      <p class="text-xs text-gray-500 mb-4 text-left">‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå<br>‚Ä¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Margins = None ‡πÅ‡∏•‡∏∞ Scale = 100%</p>
      <button onclick="window.print()" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 rounded-xl font-black shadow-lg transition-all flex items-center justify-center gap-2">
        <span>üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</span>
      </button>
      <button onclick="window.close()" class="mt-2 text-xs text-gray-400 font-bold hover:text-red-600">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>

  <div id="label-container" class="flex flex-col items-center">
    <div class="py-10 text-gray-400 font-bold no-print">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå...</div>
  </div>

  <script>
    // ** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå API_URL ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏ô‡∏∞‡∏Ñ‡∏∞ **
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const rowIndex = urlParams.get('row');
      if (!rowIndex) return;

      try {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${rowIndex}`);
        const data = await res.json();
        if (data) render(data);
      } catch (e) { 
        console.error(e);
        document.getElementById('label-container').innerHTML = `<div class="text-red-600 font-bold py-10">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>`;
      }
    });

    function render(o) {
      // --- Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ---
      const gluGrams = (parseFloat(o.dex_vol) || 0) * 0.5;
      const pctGlu = ((gluGrams / (parseFloat(o.pn_volume) || 1)) * 100).toFixed(1);
      
      const proteinGrams = (parseFloat(o.protein_target) || 0) * (parseFloat(o.bw) || 0);
      const nitrogen = proteinGrams / 6.25;
      const npc = (gluGrams * 3.4) + ((parseFloat(o.fat_vol_base) || 0) * 2);
      const npcn = nitrogen > 0 ? Math.round(npc / nitrogen) : 0;
      
      const expDate = new Date(o.order_date);
      expDate.setDate(expDate.getDate() + 1);
      const expStr = expDate.toLocaleDateString('th-TH') + " @ 18:00 ‡∏ô.";

      const container = document.getElementById('label-container');
      container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á Loading text

      // ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà 1: Macronutrients & Electrolytes
      const label1 = `
        <div class="sticker shadow-md mb-6">
          <div class="header-info flex justify-between items-center">
            <span>HN: ${o.hn} - <b>${o.patient_name}</b></span>
            <span class="label-tag">‡πÅ‡∏ú‡πà‡∏ô 1/2</span>
          </div>
          <div class="flex justify-between text-[10px] mb-1 font-bold">
            <span>Ward: ${o.ward || '-'}</span>
            <span>Route: ${o.route || '-'}</span>
          </div>
          <table>
            <tr><td class="font-bold bg-gray-50">Sterile Water</td><td class="text-right font-bold">${o.water_net || 0} ml</td><td class="bg-gray-50">Glycophos (P)</td><td class="text-right">${o.phos_vol || 0} ml</td></tr>
            <tr><td class="font-bold bg-gray-50">50% Dextrose</td><td class="text-right font-bold">${o.dex_vol || 0} ml</td><td class="bg-gray-50">3% NaCl (Na)</td><td class="text-right">${o.na_vol || 0} ml</td></tr>
            <tr><td class="font-bold bg-gray-50">${o.protein_product_name || 'Protein'}</td><td class="text-right font-bold">${o.protein_vol || 0} ml</td><td class="bg-gray-50">15% KCl (K)</td><td class="text-right">${o.k_vol || 0} ml</td></tr>
            <tr><td class="bg-gray-50">10% Ca Glu</td><td class="text-right">${o.ca_vol || 0} ml</td><td class="bg-gray-50">50% MgSO4</td><td class="text-right">${o.mg_vol || 0} ml</td></tr>
          </table>
          <div class="flex justify-between items-center mt-2 border-t border-black pt-1">
             <span class="text-[9px] italic">Srinagarind Hospital Pharmacy</span>
             <span class="text-[11px] font-black uppercase">Total PN Vol: ${o.pn_volume} ml</span>
          </div>
        </div>
      `;

      // ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà 2: Trace, Vitamins & Clinical Info
      const label2 = `
        <div class="sticker shadow-md">
          <div class="header-info flex justify-between items-center">
            <span>HN: ${o.hn} - <b>${o.patient_name}</b></span>
            <span class="label-tag">‡πÅ‡∏ú‡πà‡∏ô 2/2</span>
          </div>
          <div class="grid grid-cols-2 gap-x-2 text-[10px] mb-1">
            <span>‚Ä¢ Peditrace: <b>${o.peditrace_vol || 0} ml</b></span>
            <span>‚Ä¢ Soluvit-N: <b>${o.soluvit_vol || 0} ml</b></span>
            <span>‚Ä¢ B-Co/Vitalipid: <b>${o.vitalipid_vol || 0} ml</b></span>
            <span>‚Ä¢ Heparin: <b>${o.heparin_vol || 0} ml</b></span>
          </div>
          <div class="grid grid-cols-2 gap-1 text-[9px] border-t border-dashed border-gray-400 pt-1">
            <span>Calories: <b>${o.total_calories || 0} kcal</b></span>
            <span>NPC:N Ratio: <b>${npcn}:1</b></span>
            <span>% Glucose: <b>${pctGlu} %</b></span>
            <span>GIR: <b>${o.gir_result || 0}</b></span>
            <span>Osmolarity: <b>${o.final_osmolarity || 0}</b></span>
          </div>
          <div class="flex justify-between items-center mt-2">
            <div class="rate-box">RATE: ${o.rate_tpn || 0} ml/hr</div>
            <div class="text-[9px] text-right font-bold">
               EXP: ${expStr}<br>
               Total Volume: ${o.pn_volume} ml
            </div>
          </div>
        </div>
      `;

      container.innerHTML = label1 + label2;
    }
  </script>
</body>
</html>
