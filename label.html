<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN & FAT Label System | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    @media print {
      @page { size: 3.5in 2.48in; margin: 0; }
      body { margin: 0; padding: 0; background: #fff; }
      .no-print { display: none !important; }
      .sticker { box-shadow: none !important; border: none !important; margin: 0 !important; }
    }
    .sticker {
      width: 3.5in; height: 2.48in; padding-top: 1.1cm; padding-left: 0.1in; padding-right: 0.1in;
      box-sizing: border-box; page-break-after: always; background: white; position: relative;
    }
    table { width: 100%; font-size: 10.5px; border-collapse: collapse; margin-top: 2px; }
    td { border: 1px solid #000; padding: 1px 3px; }
    .vol-input { font-weight: 800; border: none; background: transparent; width: 45px; text-align: right; outline: none; display: inline-block; }
    .header-info { font-size: 10.5px; font-weight: 800; border-bottom: 1.5px solid #000; padding-bottom: 1px; }
    .rate-box { border: 1.5px solid #000; padding: 1px 4px; font-size: 13px; font-weight: 800; }
    .summary-text { font-size: 10px; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-md mx-auto my-4 no-print p-4 bg-white rounded-xl shadow-lg border border-gray-200 text-center">
    <h2 class="font-black text-lg mb-3">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏â‡∏•‡∏≤‡∏Å TPN & FAT</h2>
    <div class="flex gap-2 mb-3">
      <button onclick="changeBottleCount(1)" id="btn1" class="flex-1 py-2 bg-black text-white rounded-lg font-bold">PN 1 ‡∏Ç‡∏ß‡∏î</button>
      <button onclick="changeBottleCount(2)" id="btn2" class="flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold">PN 2 ‡∏Ç‡∏ß‡∏î</button>
    </div>
    <button onclick="window.print()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-black shadow-lg hover:bg-blue-700 transition-all">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div id="label-container" class="flex flex-col items-center gap-2"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;
    let bottleCount = 1;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const rowIndex = urlParams.get('row');
      if (!rowIndex) return;
      try {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${rowIndex}`);
        rawData = await res.json();
        render();
      } catch (e) { console.error(e); }
    });

    function changeBottleCount(count) {
      bottleCount = count;
      document.getElementById('btn1').className = count === 1 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      document.getElementById('btn2').className = count === 2 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      render();
    }

    function render() {
      if (!rawData) return;
      const container = document.getElementById('label-container');
      container.innerHTML = '';
      const div = bottleCount;

      // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å TPN ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      for (let i = 1; i <= bottleCount; i++) {
        container.innerHTML += createPNSticker(rawData, i, div, 1);
        container.innerHTML += createPNSticker(rawData, i, div, 2);
      }

      // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å FAT (‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏™‡∏°‡∏≠)
      container.innerHTML += createFatSticker(rawData);

      // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏∏‡∏á (‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏™‡∏°‡∏≠)
      container.innerHTML += createBagSticker(rawData);
    }

    const smartFix = (v, div = 1) => {
        let num = parseFloat(v) / div;
        return (isNaN(num)) ? "0" : Number(num.toFixed(2));
    };

    function createPNSticker(o, bNum, div, part) {
      const routeText = o.route?.toLowerCase() === 'central' ? 'C-line' : 'P-line';
      const d = new Date(o.order_date);
      d.setDate(d.getDate() + 1);
      const expDateStr = d.toLocaleDateString('th-TH');
      
      const getProteinName = (name) => {
          const n = name?.toLowerCase();
          if (n === "aminoven" || n === "amiparen") return "10% Aminoven infant";
          if (n === "aminoplasmal") return "15% Aminoplasmal";
          return name || "Amino Acids";
      };

      if (part === 1) {
        return `<div class="sticker">
          <div class="header-info flex justify-between">
            <span>HN: ${o.hn} - ${o.patient_name}</span>
            <span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${div}</span>
          </div>
          <div class="flex justify-between text-[10px] font-bold">
            <span>Ward: ${o.ward || '-'}</span>
            <span>Route: ${routeText}</span>
          </div>
          <table>
            <tr><td>1. Sterile Water for Injection</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.water_net, div)}"></b> ml</td></tr>
            <tr><td>2. 50% Dextrose</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.dex_vol, div)}"></b> ml</td></tr>
            <tr><td>3. ${getProteinName(o.protein_product_name)}</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.protein_vol, div)}"></b> ml</td></tr>
            <tr><td>4. Glycophos (P)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.phos_vol, div)}"></b> ml</td></tr>
            <tr><td>5. 3% NaCl (Na)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.na_vol, div)}"></b> ml</td></tr>
            <tr><td>6. 15% KCl (K)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.k_vol, div)}"></b> ml</td></tr>
            <tr><td>7. 50% MgSO4</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.mg_vol, div)}"></b> ml</td></tr>
            <tr><td>8. 10% Ca Gluconate</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.ca_vol, div)}"></b> ml</td></tr>
          </table>
        </div>`;
      } else {
        const bw = parseFloat(o.bw) || 1;
        const proteinGramsTotal = (parseFloat(o.protein_target) || 0) * bw;
        const nitrogenTotal = proteinGramsTotal / 6.25;
        const dexGramsTotal = (parseFloat(o.dex_vol) || 0) * 0.5;
        const fatCalTotal = (parseFloat(o.fat_vol_base) || 0) * 2;
        const npcCalTotal = (dexGramsTotal * 3.4) + fatCalTotal;
        const npcnValue = (nitrogenTotal > 0) ? Math.round(npcCalTotal / nitrogenTotal) : 0;
        const npcnDisplay = (npcnValue > 0) ? `${npcnValue}:1` : "-";

        return `<div class="sticker">
          <div class="header-info flex justify-between">
            <span>HN: ${o.hn} - ${o.patient_name}</span>
            <span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${div}</span>
          </div>
          <table>
             <tr><td>9. Peditrace</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.peditrace_vol, div)}"></b> ml</td></tr>
             <tr><td>10. Soluvit-N</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.soluvit_vol, div)}"></b> ml</td></tr>
             <tr><td>11. ${o.additive_other_name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"}</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.additive_other_volume, div)}"></b> ml</td></tr>
             <tr><td>12. Heparin (1u/ml)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.heparin_vol, div)}"></b> ml</td></tr>
          </table>
          <div class="grid grid-cols-2 gap-x-2 summary-text mt-1 border-t border-black pt-1">
            <span>Total PN calories: <b>${o.total_calories || 0} kcal</b></span>
            <span>NPC:N Ratio: <b>${npcnDisplay}</b></span>
            <span>% Glucose: <b>${o.dextrose_percent || 0} %</b></span>
            <span>GIR: <b>${o.gir_result || 0}</b></span>
            <span class="col-span-2">Osmolarity: <b>${o.final_osmolarity || 0} mOsmol/L</b></span>
          </div>
          <div class="flex justify-between items-end mt-1">
            <div class="rate-box font-mono">RATE: ${o.rate_tpn || 0} ml/hr</div>
            <div class="text-[9px] text-right font-bold">
               ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${expDateStr} ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô.<br>
               Total volume: ${smartFix(o.pn_volume, div)} ml
            </div>
          </div>
        </div>`;
      }
    }

    function createFatSticker(o) {
      const d = new Date(o.order_date);
      const orderDateStr = d.toLocaleDateString('th-TH');
      d.setDate(d.getDate() + 1);
      const expStr = d.toLocaleDateString('th-TH');

      return `<div class="sticker">
        <div class="header-info">HN: ${o.hn} - ${o.patient_name} | Ward: ${o.ward}</div>
        <div class="text-[11px] font-bold mt-2 mb-1 text-center border-b border-black">FAT INFUSION LABEL</div>
        <table class="mt-2">
          <tr><td>Fat Product: ${o.fat_product_name || '-'}</td><td class="text-right"><b>${o.total_fat_vit_flush || 0}</b> ml</td></tr>
          <tr><td>Added: ${o.vit_product || '-'}</td><td class="text-right"><b>${o.vitalipid_vol || 0}</b> ml</td></tr>
          <tr><td>Flush (‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢)</td><td class="text-right"><b>${o.flush_volume || 0}</b> ml</td></tr>
        </table>
        <div class="flex justify-between items-center mt-3">
          <div class="rate-box">Fat rate: ${o.fat_rate || 0} ml/hr</div>
          <div class="text-[10px] font-bold text-right">
            Total volume: ${o.total_fat_vit_flush || 0} ml<br>
            Order date: ${orderDateStr}
          </div>
        </div>
        <div class="mt-2 text-[10px] border-t border-black pt-1 font-bold">
          ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${expStr} ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô.
        </div>
      </div>`;
    }

    function createBagSticker(o) {
      const orderStr = new Date(o.order_date).toLocaleDateString('th-TH');
      return `<div class="sticker flex flex-col items-center justify-center text-center">
        <div class="text-5xl font-black mb-2">${o.ward}</div>
        <div class="text-2xl font-bold border-y-2 border-black w-full py-3 my-2">${o.patient_name}</div>
        <div class="text-lg">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°: <b>${orderStr}</b></div>
        <div class="text-xl font-black mt-4">(‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≤‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 2-8¬∞ C)</div>
      </div>`;
    }
  </script>
</body>
</html>
