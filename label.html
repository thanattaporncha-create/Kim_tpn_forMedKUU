<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN, FAT & BAG Label | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; }
    @media print {
      @page { size: 3.5in 2.48in; margin: 0; }
      body { margin: 0; padding: 0; background: #fff; }
      .no-print { display: none !important; }
      .sticker { box-shadow: none !important; border: none !important; margin: 0 !important; }
    }
    .sticker {
      width: 3.5in; height: 2.48in; padding-top: 1.1cm; padding-left: 0.1in; padding-right: 0.1in;
      box-sizing: border-box; page-break-after: always; background: white; position: relative;
    }
    table { width: 100%; font-size: 10.5px; border-collapse: collapse; margin-top: 2px; }
    td { border: 1px solid #000; padding: 1px 3px; }
    .vol-input { font-weight: 800; border: none; background: transparent; width: 50px; text-align: right; outline: none; }
    .header-info { font-size: 10.5px; font-weight: 800; border-bottom: 1.5px solid #000; padding-bottom: 1px; }
    .rate-box { border: 1.5px solid #000; padding: 1px 4px; font-size: 13px; font-weight: 800; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-md mx-auto my-4 no-print p-4 bg-white rounded-xl shadow-lg border border-gray-200">
    <h2 class="font-black text-center text-lg mb-4">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</h2>
    <div class="mb-4">
      <label class="block text-xs font-bold mb-1 uppercase tracking-wider text-blue-900">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ß‡∏î TPN</label>
      <div class="flex gap-2">
        <button onclick="changePNCount(1)" id="pn1" class="flex-1 py-2 bg-black text-white rounded-lg font-bold">1 ‡∏Ç‡∏ß‡∏î</button>
        <button onclick="changePNCount(2)" id="pn2" class="flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold">2 ‡∏Ç‡∏ß‡∏î</button>
      </div>
    </div>
    <div class="mb-4">
      <label class="block text-xs font-bold mb-1 uppercase tracking-wider text-amber-900">üíâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Syringe Fat</label>
      <div class="flex gap-2">
        <button onclick="changeFatCount(1)" id="fat1" class="flex-1 py-2 bg-black text-white rounded-lg font-bold">1 ‡∏≠‡∏±‡∏ô</button>
        <button onclick="changeFatCount(2)" id="fat2" class="flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold">2 ‡∏≠‡∏±‡∏ô</button>
      </div>
    </div>
    <button onclick="window.print()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-black shadow-lg">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div id="label-container" class="flex flex-col items-center gap-2"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwAXIgHNvWpROWj74igzeK5nxaq2nSjFOeXrxgLILxJBhkr8HYz6asFsRPVJNNX7lFK/exec';
    let rawData = null;
    let pnBottleCount = 1;
    let fatSyrCount = 1;

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const rowIndex = urlParams.get('row');
      if (!rowIndex) return;
      try {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${rowIndex}`);
        rawData = await res.json();
        render();
      } catch (e) { console.error(e); }
    });

    function formatThaiDate(dateObj) {
      const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      const d = new Date(dateObj);
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    function changePNCount(c) { pnBottleCount = c; updateButtons(); render(); }
    function changeFatCount(c) { fatSyrCount = c; updateButtons(); render(); }
    function updateButtons() {
      document.getElementById('pn1').className = pnBottleCount === 1 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      document.getElementById('pn2').className = pnBottleCount === 2 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      document.getElementById('fat1').className = fatSyrCount === 1 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
      document.getElementById('fat2').className = fatSyrCount === 2 ? "flex-1 py-2 bg-black text-white rounded-lg font-bold" : "flex-1 py-2 bg-gray-200 text-black rounded-lg font-bold";
    }

    function render() {
      if (!rawData) return;
      const container = document.getElementById('label-container');
      container.innerHTML = '';
      for (let i = 1; i <= pnBottleCount; i++) {
        container.innerHTML += createPNSticker(rawData, i, pnBottleCount, 1);
        container.innerHTML += createPNSticker(rawData, i, pnBottleCount, 2);
      }
      for (let j = 1; j <= fatSyrCount; j++) {
        container.innerHTML += createFatSticker(rawData, j, fatSyrCount);
      }
      container.innerHTML += createBagSticker(rawData);
    }

    const smartFix = (v, div = 1) => {
        let num = parseFloat(v) / div;
        return (isNaN(num)) ? "0" : Number(num.toFixed(2));
    };

    function createPNSticker(o, bNum, div, part) {
      const routeText = o.route?.toLowerCase() === 'central' ? 'C-line' : 'P-line';
      const expDate = new Date(o.order_date); expDate.setDate(expDate.getDate() + 1);
      
      const getProteinName = (name) => {
          const n = name?.toLowerCase();
          if (n === "aminoven" || n === "amiparen") return "10% Aminoven infant";
          if (n === "aminoplasmal") return "15% Aminoplasmal";
          return name || "Amino Acids";
      };

      if (part === 1) {
        return `<div class="sticker">
          <div class="header-info flex justify-between"><span>HN: ${o.hn} - ${o.patient_name}</span><span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${div}</span></div>
          <div class="flex justify-between text-[10px] font-bold"><span>Ward: ${o.ward}</span><span>Route: ${routeText}</span></div>
          <table>
            <tr><td>1. Sterile Water for Injection</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.water_net, div)}"></b> ml</td></tr>
            <tr><td>2. 50% Dextrose</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.dex_vol, div)}"></b> ml</td></tr>
            <tr><td>3. ${getProteinName(o.protein_product_name)}</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.protein_vol, div)}"></b> ml</td></tr>
            <tr><td>4. Glycophos (P)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.phos_vol, div)}"></b> ml</td></tr>
            <tr><td>5. 3% NaCl (Na)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.na_vol, div)}"></b> ml</td></tr>
            <tr><td>6. 15% KCl (K)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.k_vol, div)}"></b> ml</td></tr>
            <tr><td>7. 50% MgSO4</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.mg_vol, div)}"></b> ml</td></tr>
            <tr><td>8. 10% Ca Gluconate</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.ca_vol, div)}"></b> ml</td></tr>
          </table>
        </div>`;
      } else {
        const bw = parseFloat(o.bw) || 1;
        const nTotal = ((parseFloat(o.protein_target) || 0) * bw) / 6.25;
        const npcTotal = ((parseFloat(o.dex_vol) * 0.5) * 3.4) + (parseFloat(o.fat_vol_base) * 2);
        const npcnDisplay = nTotal > 0 ? Math.round(npcTotal / nTotal) + ":1" : "-";

        return `<div class="sticker">
          <div class="header-info flex justify-between"><span>HN: ${o.hn} - ${o.patient_name}</span><span>‡∏Ç‡∏ß‡∏î‡∏ó‡∏µ‡πà: ${bNum}/${div}</span></div>
          <table>
             <tr><td>9. Peditrace</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.peditrace_vol, div)}"></b> ml</td></tr>
             <tr><td>10. Zinc sulfate</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.zinc_vol, div)}"></b> ml</td></tr>
             <tr><td>11. Soluvit-N</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.soluvit_vol, div)}"></b> ml</td></tr>
             <tr><td>12. ${o.additive_other_name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"}</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.additive_other_volume, div)}"></b> ml</td></tr>
             <tr><td>13. Heparin (1u/ml)</td><td class="text-right"><b><input class="vol-input" value="${smartFix(o.heparin_vol, div)}"></b> ml</td></tr>
          </table>
          <div class="grid grid-cols-2 gap-x-1 text-[9px] mt-1 border-t border-black pt-1 font-bold">
            <span>Total PN kcal: ${o.total_calories}</span><span>NPC:N: ${npcnDisplay}</span>
            <span>% Glucose: ${o.dextrose_percent}%</span><span>Osmol: ${o.final_osmolarity}</span>
          </div>
          <div class="flex justify-between items-end mt-1">
            <div class="rate-box font-mono">RATE: ${o.rate_tpn} ml/hr</div>
            <div class="text-[9px] text-right font-bold">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${formatThaiDate(expDate)} 18:00 ‡∏ô.<br>Total Vol: ${smartFix(o.pn_volume, div)} ml</div>
          </div>
        </div>`;
      }
    }

    function createFatSticker(o, fNum, div) {
      const orderDate = new Date(o.order_date);
      const expDate = new Date(o.order_date); expDate.setDate(expDate.getDate() + 1);
      const getFatName = (name) => name?.toLowerCase() === "smof" ? "20% SMOF lipid" : name;
      const getVitName = (name) => {
          const n = name?.toLowerCase();
          if (n === "infant") return "Vitalipid N-Infant";
          if (n === "adult") return "Vitalipid N-Adult";
          return name;
      };
      return `<div class="sticker">
        <div class="header-info">HN: ${o.hn} - ${o.patient_name} | Ward: ${o.ward}</div>
        <div class="text-[11px] font-bold mt-2 mb-1 text-center border-b border-black">FAT INFUSION (Syr. ${fNum}/${div})</div>
        <table class="mt-2">
          <tr><td>Fat Product: ${getFatName(o.fat_product_name)}</td><td class="text-right"><b>${smartFix(o.total_fat_vit_flush, div)}</b> ml</td></tr>
          <tr><td>Added: ${getVitName(o.vit_product)}</td><td class="text-right"><b>${smartFix(o.vitalipid_vol, div)}</b> ml</td></tr>
          <tr><td>Flush (‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢)</td><td class="text-right"><b>${smartFix(o.flush_volume, div)}</b> ml</td></tr>
        </table>
        <div class="flex justify-between items-center mt-3">
          <div class="rate-box">Fat rate: ${o.fat_rate || 0} ml/hr</div>
          <div class="text-[10px] font-bold text-right">Total: ${smartFix(o.total_fat_vit_flush, div)} ml<br>Order: ${formatThaiDate(orderDate)}</div>
        </div>
        <div class="mt-2 text-[10px] border-t border-black pt-1 font-bold">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${formatThaiDate(expDate)} ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô.</div>
      </div>`;
    }

    function createBagSticker(o) {
      const orderDate = new Date(o.order_date);
      return `<div class="sticker flex flex-col items-center justify-center text-center">
        <div class="text-5xl font-black mb-1">${o.ward}</div>
        <div class="text-xl font-bold border-y-2 border-black w-full py-1 my-1">${o.patient_name}</div>
        <div class="text-lg font-black">HN: ${o.hn}</div>
        <div class="text-base mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°: <b>${formatThaiDate(orderDate)}</b></div>
        <div class="text-lg font-black mt-2 bg-black text-white px-4 py-1 rounded-full">(‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≤‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 2-8¬∞ C)</div>
      </div>`;
    }
  </script>
</body>
</html>
