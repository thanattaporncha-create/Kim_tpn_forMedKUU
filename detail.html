<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Order Report | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.2; }
    @media print {
      @page { size: A4; margin: 8mm; }
      body { background-color: white; }
      .no-print { display: none !important; }
      .print-container { border: none !important; width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; }
    }
    .print-container { width: 210mm; min-height: 297mm; margin: 0 auto; background: white; padding: 10mm; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
    th, td { border: 1px solid #000; padding: 3px 6px; font-size: 11px; }
    th { background-color: #f2f2f2; font-weight: 800; text-transform: uppercase; }
    .section-header { background-color: #1e3a5f; color: white !important; padding: 3px 10px; font-weight: 800; font-size: 12px; margin-top: 8px; border-radius: 4px; }
    .category-row { background-color: #f9f9f9; font-weight: 800; font-size: 10px; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-[210mm] mx-auto my-4 flex justify-between no-print px-4">
    <button onclick="window.close()" class="font-bold text-gray-500">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Dashboard</button>
    <button onclick="window.print()" class="bg-blue-600 text-white px-8 py-2 rounded-full font-black shadow-lg">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (A4)</button>
  </div>

  <div class="print-container border border-gray-200 shadow-xl">
    <div class="flex justify-between items-start border-b-2 border-black pb-2 mb-3">
      <div>
        <h1 class="text-xl font-extrabold tracking-tighter uppercase">TPN Order Report</h1>
        <p class="text-[11px] font-bold">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</p>
      </div>
      <div class="flex gap-2">
        <div class="text-right pr-3 border-r-2 border-black">
          <p class="text-[9px] font-black text-gray-500 uppercase">Order Date</p>
          <p id="pDate" class="text-sm font-black">-</p>
        </div>
        <div class="text-center border-2 border-black px-4 py-1 rounded-lg">
          <p class="text-[9px] font-black uppercase text-gray-500">Ward</p>
          <p id="pWard" class="text-2xl font-black leading-none">-</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-4 gap-3 text-[11px] mb-3 bg-gray-50 p-3 rounded-lg border border-gray-200 font-black">
      <div class="col-span-2">Name: <span id="pName" class="text-sm text-blue-900">-</span></div>
      <div>HN: <span id="pHN" class="font-mono">-</span></div>
      <div>Weight: <span id="pBW">-</span> kg</div>
      <div>Route: <span id="pRoute" class="uppercase">-</span></div>
      <div>PN Vol (Net): <span id="vol-pn" class="text-blue-800">-</span> ml</div>
      <div>Rate PN: <span id="rate-pn" class="text-blue-800">-</span> ml/hr</div>
      <div class="italic text-[8px] text-gray-400 text-right col-span-2">Generated: <span id="genTime"></span></div>
    </div>

    <div class="section-header">üß™ TPN Composition (PN Solution)</div>
    <table>
      <thead>
        <tr>
          <th class="text-left">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</th>
          <th class="w-20">Dosage</th>
          <th class="w-24">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (ml)</th>
          <th class="w-24">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (ml)</th>
          <th class="w-24">Note</th>
        </tr>
      </thead>
      <tbody id="tpnTable"></tbody>
    </table>

    <div id="fatSection" class="hidden">
      <div class="section-header">üßà ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat (Lipid Emulsion)</div>
      <div class="p-3 border-2 border-dashed border-green-600 rounded-lg mt-1 bg-green-50/20 grid grid-cols-2 gap-4">
        <div class="text-[11px] space-y-1">
          <p><span class="font-bold">Lipid Product:</span> <span id="fat-product" class="font-black text-green-800">-</span></p>
          <p><span class="font-bold">Volume Fat:</span> <span id="fat-vol-base" class="font-black">-</span> ml</p>
          <p><span class="font-bold">‡∏ö‡∏ß‡∏Å‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢:</span> <span id="fat-flush" class="font-black">-</span> ml</p>
          <p><span class="font-bold">Vitalipid-N:</span> <span id="fat-vita" class="font-black text-blue-700">-</span> ml</p>
          <p class="text-blue-900 font-bold border-t border-blue-200 pt-1 text-sm">Total Fat Administration: <span id="fat-total-all" class="text-base">-</span> ml</p>
        </div>
        <div class="text-[11px] space-y-1 border-l border-green-200 pl-4">
          <p><span class="font-bold text-green-700">Drip Rate:</span> <span id="fat-rate-val" class="font-bold text-base">-</span> ml/hr</p>
          <p><span class="font-bold text-green-700">Fat Requirement:</span> <span id="fat-req" class="font-black">-</span> g/kg/day</p>
          <p><span class="font-bold">‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</span> <span id="fat-split" class="font-black">-</span></p>
        </div>
      </div>
    </div>

    <div class="section-header">üìä Clinical Summary</div>
    <div class="grid grid-cols-3 gap-2 mt-1">
      <div class="border border-black p-2 text-center bg-gray-50">
        <p class="text-[9px] font-bold uppercase text-gray-400">Total Calories</p>
        <p id="val-cal" class="text-lg font-black">-</p>
      </div>
      <div class="border border-black p-2 text-center bg-gray-50">
        <p class="text-[9px] font-bold uppercase text-gray-400">Osmolarity</p>
        <p id="val-osmol" class="text-lg font-black">-</p>
      </div>
      <div class="border border-black p-2 text-center bg-gray-50">
        <p class="text-[9px] font-bold uppercase text-gray-400">GIR (mg/kg/min)</p>
        <p id="val-gir" class="text-lg font-black">-</p>
      </div>
    </div>

    <div class="mt-auto pt-10 grid grid-cols-4 gap-4 text-center">
      <div class="border-t border-black pt-1"><p class="text-[9px] font-black uppercase">Physician</p></div>
      <div class="border-t border-black pt-1"><p class="text-[9px] font-black uppercase">Verified By (Phar)</p></div>
      <div class="border-t border-black pt-1"><p class="text-[9px] font-black uppercase">Prepared By</p></div>
      <div class="border-t border-black pt-1"><p class="text-[9px] font-black uppercase">Dispensed By</p></div>
    </div>
  </div>

  <script>
    // URL ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏° Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const API_URL = 'https://script.google.com/macros/s/AKfycbwZTuzu8mDaLu3m7ic_qqTJfcSjDLWKcK4UcMPv5jusecDDqThZ_rFHXpXno89Q8Ok/exec';

    document.addEventListener('DOMContentLoaded', fetchOrderDetail);

    async function fetchOrderDetail() {
      const row = new URLSearchParams(window.location.search).get('row');
      try {
        const res = await fetch(`${API_URL}?action=getDataDetail&row_index=${row}`);
        const order = await res.json();
        if (order) displayReport(order);
      } catch (e) { console.error("Error fetching detail:", e); }
    }

    function displayReport(o) {
      document.getElementById('pDate').innerText = o.order_date ? new Date(o.order_date).toLocaleDateString('th-TH') : '-';
      document.getElementById('pWard').innerText = o.ward || '-';
      document.getElementById('pName').innerText = o.patient_name || '-';
      document.getElementById('pHN').innerText = o.hn || '-';
      document.getElementById('pBW').innerText = o.bw || '-';
      document.getElementById('pRoute').innerText = o.route || '-';
      document.getElementById('vol-pn').innerText = o.pn_volume || '0';
      document.getElementById('rate-pn').innerText = o.rate_tpn || '0';
      document.getElementById('genTime').innerText = new Date().toLocaleString('th-TH');

      document.getElementById('val-cal').innerText = (o.total_calories || 0) + ' kcal';
      document.getElementById('val-osmol').innerText = (o.osmolarity || 0) + ' mOsm/L';
      document.getElementById('val-gir').innerText = o.gir_result || '0';

      const table = document.getElementById('tpnTable');
      
      const categories = [
        { label: "Macronutrients", items: [
          { n: o.protein_product_name || "Amino Acid", d: `${o.protein_target} g/kg`, v: o.protein_vol, p: o.prep_protein_vol, note: "" },
          { n: "50% Dextrose", d: `${o.dextrose_percent} %`, v: o.dex_vol, p: o.prep_dex_50_vol, note: `Total Gram: ${o.dex_grams || '-'} g` }
        ]},
        { label: "Electrolytes", items: [
          { n: "- Glycophos (P)", d: `${o.phosphorus} mEq/kg`, v: o.phos_vol, p: o.prep_phos_vol, note: `Na from P: ${o.na_from_p_meq} mEq` },
          { n: "- 3% Sodium Chloride (Na)", d: `${o.sodium} mEq/kg`, v: o.na_vol, p: o.prep_na_vol, note: "" },
          { n: "- Potassium Chloride (K)", d: `${o.potassium} mEq/kg`, v: o.k_vol, p: o.prep_k_vol, note: "" },
          { n: "- 50% Magnesium Sulfate (Mg)", d: `${o.magnesium} mmol/kg`, v: o.mg_vol, p: o.prep_mg_vol, note: "" },
          { n: "- 10% Calcium Gluconate (Ca)", d: `${o.calcium} ml/kg`, v: o.ca_vol, p: o.prep_ca_vol, note: "" }
        ]},
        { label: "Vitamins & Trace Elements", items: [
          { n: "- Soluvit N", d: "-", v: o.soluvit_vol, p: o.prep_soluvit_vol, note: "" },
          { n: "- Peditrace", d: "-", v: o.peditrace_vol, p: o.prep_peditrace_vol, note: "" }
        ]},
        { label: "Additives", items: [
          { n: `- Zinc Sulfate (Preterm)`, d: o.zinc_added === 'yes' ? 'Yes' : 'No', v: o.zinc_vol, p: o.prep_zinc_vol, note: "" },
          { n: `- Heparin`, d: `${o.heparin_units} units`, v: o.heparin_vol, p: o.prep_heparin_vol, note: "" },
          { n: `- ${o.additive_other_name || "Other Additive"}`, d: "-", v: o.additive_other_volume, p: o.prep_other_vol, note: "" }
        ]},
        { label: "Sterile Water", items: [
          { n: "Sterile Water for Injection", d: "-", v: o.water_net, p: o.prep_water_vol, note: "" }
        ]}
      ];

      let tableHtml = "";
      categories.forEach(cat => {
        tableHtml += `<tr class="category-row"><td colspan="5" class="px-2 py-0.5">${cat.label}</td></tr>`;
        cat.items.forEach(i => {
          const val = parseFloat(i.v) || 0;
          tableHtml += `
            <tr class="${val === 0 ? 'text-gray-300' : ''}">
              <td class="pl-4 font-bold">${i.n}</td>
              <td class="text-center font-mono">${i.d || '-'}</td>
              <td class="text-center font-black">${val} ml</td>
              <td class="text-center font-bold text-blue-800 bg-blue-50/50">${i.p || 0} ml</td>
              <td class="text-[9px] italic">${i.note}</td>
            </tr>`;
        });
      });
      table.innerHTML = tableHtml;

      // Fat Section
      if (parseFloat(o.fat_target) > 0) {
        document.getElementById('fatSection').classList.remove('hidden');
        document.getElementById('fat-product').innerText = o.fat_product_name || 'Lipid';
        document.getElementById('fat-vol-base').innerText = o.fat_volume || '0';
        document.getElementById('fat-flush').innerText = o.flush_volume || '0';
        document.getElementById('fat-vita').innerText = o.vitalipid_vol || '0';
        document.getElementById('fat-total-all').innerText = o.total_fat_vit_flush || '0';
        document.getElementById('fat-rate-val').innerText = o.fat_rate || '0';
        document.getElementById('fat-req').innerText = o.fat_target || '0';
        document.getElementById('fat-split').innerText = o.prep_split === 'split' ? '‡πÅ‡∏ö‡πà‡∏á 2 Syringe' : '‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á';
      }
    }
  </script>
</body>
</html>
